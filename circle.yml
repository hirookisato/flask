machine:
  timezone:
    Asia/Tokyo
  services:
    - docker
  python:
    version: 2.7.11
  environment:
    FLASK_APP: flaskr.py
    REGISTRY: registry.ng.bluemix.net/kaneko/flaskr
    ENDPOINT: https://api.ng.bluemix.net

dependencies:
  pre:
    - sudo apt-get install -y jq
    - curl -v -L -o cf-cli_amd64.deb 'https://cli.run.pivotal.io/stable?release=debian64&source=github'
    - sudo dpkg -i cf-cli_amd64.deb
    - cf install-plugin -f https://static-ice.ng.bluemix.net/ibm-containers-linux_x64
    - docker build -t $REGISTRY .:
        pwd: examples/flaskr
  override:
    - pip install flask pytest

test:
  override:
    - py.test:
        pwd: examples/flaskr
    - docker run -d -p 80:80 $REGISTRY; sleep 5
    - curl --retry 3 --retry-delay 5 -v http://localhost
  post:
    - cf api $ENDPOINT
    - cf login -u $BLUEMIX_USER -p $BLUEMIX_PASSWORD -o $BLUEMIX_ORG -s $BLUEMIX_SPACE
    - cf ic login

deployment:
  production:
    branch: bluemix-docker
    commands:
      - docker push registry.ng.bluemix.net/kaneko/flaskr
      - id=`cf ic ps | grep $REGISTRY | awk '{print $1}'`
      - echo $id
      - ip=`cf ic inspect $id | jq -r '.[0].NetworkSettings.PublicIpAddress'`
      - echo $ip
      - cf ic ip unbind $ip $id
      - cf ic run -p 80 $REGISTRY
      - cf ic rm -f $id
